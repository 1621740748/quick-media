# 二维码插件概览
> qrcode-plugin 在开源二维码处理库zxing的基础上，重写了二维码渲染的逻辑，以支持更灵活、更个性化的二维码生成规则

## 1. 功能介绍

大的方面主要分为二维码的生成和解析两块，qrcode-plugin生成二维码的功能上，做了深度的开发定制，目前基本上可以覆盖二维码的各种生成场景

- [x] 个性二维码生成
    - 支持logo
    - 支持logo样式 （圆角logo， 边框）
    - 支持二维码颜色设置
    - 支持探测图形颜色设置
    - 支持背景图
    - 支持base64格式的二维码图片
    - 支持二维码定制绘制信息样式
     - 三角形
     - 矩形
     - 五边形 （五角星待支持）
     - 六边形
     - 八边形
     - 圆
     - 自定义图片
- [x] 动态二维码生成支持

## 2. 使用尝鲜

### - 环境配置

首先添加仓库地址，并引入qrcode-plugin依赖，请注意引入最新的版本

```xml
<repositories>
    <repository>
        <id>yihui-maven-repo</id>
        <url>https://raw.githubusercontent.com/liuyueyi/maven-repository/master/repository</url>
    </repository>
</repositories>


<dependency>
    <groupId>com.github.hui.media</groupId>
    <artifactId>qrcode-plugin</artifactId>
    <version>2.1</version>
</dependency>
```

### - 实例case


使用`qrcode-plugin`插件生成二维码是一个非常简单的事情，通过一些基本的参数来控制输出二维码样式，一个链式调用即可完成

**参数说明**

二维码图片的基本参数

```java
/**
 * 内容
 */
private String msg;

/**
 * 输出图片宽
 */
private Integer w;


/**
 * 输出图片高
 */
private Integer h;


/**
 * 内容编码, default UTF-8
 */
private String code = "utf-8";


/**
 * 边框 0 - 4 （0表示无边框）
 */
private Integer padding;


/**
 * 容错级别
 */
private ErrorCorrectionLevel errorCorrection = ErrorCorrectionLevel.H;


/**
 * 输出二维码图片类型
 */
private String picType = "png";
```

探测图形(二维码左上，右上，左下三个方框)的参数配置

```java
/**
 * 外面的方框颜色
 */ 
private Color outColor;

/**
 * 内部方框颜色
 */
private Color inColor;

/**
 * 探测图形，优先级高于颜色的定制（即存在图片时，用图片绘制探测图形）
 */
private BufferedImage detectImg;
```

二维码图形(就是普通二维码中的黑点)绘制参数: 

```java
/**
 * 着色颜色
 */
private Color preColor;

/**
 * 背景颜色
 */
private Color bgColor;

/**
 * 绘制样式: 矩形，三角，原点，五边形，六边形，八边形，图片
 */
private DrawStyle drawStyle;


/**
 * true 时表示支持对相邻的着色点进行合并处理 （即用一个大图来绘制相邻的两个着色点）
 * <p>
 * 说明： 三角形样式关闭该选项，因为留白过多，对识别有影响
 */
private boolean enableScale;

/**
 * 渲染图
 */
private Map<DotSize, BufferedImage> imgMapper;
```

logo样式配置

```java
/**
 * logo 图片
 */
private BufferedImage logo;

/**
 * logo 样式 (圆角，普通)
 */
private LogoStyle logoStyle;

/**
 * logo 占二维码的比例
 */
private int rate;

/**
 * true 表示有边框，
 * false 表示无边框
 */
private boolean border;

/**
 * 边框颜色
 */
private Color borderColor;
```

背景图配置

```java
/**
 * 背景图(静态二维码时使用)
 */
private BufferedImage bgImg;

/**
 * 动态背景图(动态二维码生成时使用)
 */
private GifDecoder gifDecoder;

/**
 * 背景图宽
 */
private int bgW;

/**
 * 背景图高
 */
private int bgH;

/**
 * 背景图样式（全覆盖，指定位置填充）
 */
private BgImgStyle bgImgStyle;

/**
 * if {@link #bgImgStyle} ==  QrCodeOptions.BgImgStyle.OVERRIDE，
 * 用于设置二维码的透明度
 */
private float opacity;


/**
 * if {@link #bgImgStyle} ==  QrCodeOptions.BgImgStyle.FILL
 * <p>
 * 用于设置二维码的绘制在背景图上的x坐标
 */
private int startX;


/**
 * if {@link #bgImgStyle} ==  QrCodeOptions.BgImgStyle.FILL
 * <p>
 * 用于设置二维码的绘制在背景图上的y坐标
 */
private int startY;
```


#### a. 基本二维码

生成一个最常见的最普通的二维码，并保存到`qr.png`文件，一行代码即可

```java
String msg = "http://weixin.qq.com/r/FS9waAPEg178rUcL93oH";
// 生成二维码，并输出为qr.png图片
boolean ans = QrCodeGenWrapper.of(msg).asFile("qr.png");
```

### b. 颜色指定

默认的二维码为白底黑块，如果我希望生成白底红块（探测图形外绿内红）的二维码，可以如下使用

```java
String msg = "http://weixin.qq.com/r/FS9waAPEg178rUcL93oH";
boolan asn = QrCodeGenWrapper.of(msg)
        .setW(300)
        .setDetectOutColor(0xff00FF00)
        .setDetectInColor(0xffff0000)
        .setDrawPreColor(0xffff0000)
        .setDrawBgColor(0xffffffff)
        .setPadding(0)
        .asFile("src/test/qrcode/gen_300x300.png");
```


### c. 带logo二维码生成

logo目前支持两种样式，一个是圆角logo，一个是直接原图不做处理（具体的参数可以键上面的处理）

```java
String logo = "https://static.oschina.net/uploads/user/283/566591_100.jpeg";
boolean ans = QrCodeGenWrapper.of(msg)
        .setW(300)
        .setDrawPreColor(0xffff0000)
        .setDrawBgColor(0xffffffff)
        .setPadding(0)
        .setLogo(logo)
//       当不指定logo的样式和边框时，如果logo为png，那么透明的地方会显示二维码信息
        .setLogoBgColor(0xff808080)
        .setLogoBorder(true)
        .asFile("src/test/qrcode/gen_300x300_logo.png");
````

### d. 指定背景图

背景图目前支持三种样式，分别是二维码全覆盖在背景图上，在背景图的自定区间进行绘制二维码，生成透明二维码但使用背景图进行渲染，下面

```java
String logo = "logo.jpg";
String bg = "bg.png";
boolean ans = QrCodeGenWrapper.of(msg)
        .setW(300)
        .setDrawPreColor(0xff0000ff)
        .setDrawBgColor(0xffffffff)
        .setDetectOutColor(0xff00FF00)
        .setDetectInColor(0xffff0000)
        .setPadding(1)
        .setLogo(logo)
        .setLogoRate(12)
        .setLogoStyle(QrCodeOptions.LogoStyle.ROUND)
        .setLogoBorder(true)
        .setLogoBgColor(Color.GREEN)
        .setBgImg(bg)
        .setBgOpacity(0.8f)
        .setBgStyle(QrCodeOptions.BgImgStyle.FILL)
        .setBgStartX(108)
        .setBgStartY(40)
        .asFile("src/test/qrcode/gen_300x300_logo_v4.png");
```

### e. 几何样式二维码生成

默认的二维码的信息为黑色小方块，本插件提供了其他的几个常见的几何形式支持，如圆点，三角，钻石，六边形，八边形；通过指定DrawStyle参数即可

```java
int size = 500;
BufferedImage img = QrCodeGenWrapper.of(msg)
        .setW(size)
        .setH(size)
        .setDrawPreColor(0xff008e59)
        .setErrorCorrection(ErrorCorrectionLevel.M)
        .setLogoStyle(QrCodeOptions.LogoStyle.ROUND)
        .setLogoBgColor(Color.LIGHT_GRAY)
        .setLogo(logo)
        .setLogoRate(10)
        .setDrawStyle(QrCodeOptions.DrawStyle.CIRCLE)
        .setDrawEnableScale(true)
        .asBufferedImage();
ImageIO.write(img, "png", new File("src/test/qrcode/style.png"));
```

### f. 图片填充

如果你有一套完整的素材，那么可以考虑用这些素材来生成一个更漂亮的二维码； 

比如项目的测试中，给出了两套输出，一个爱心，一个集合图形


```java
@Test
String msg = "http://weixin.qq.com/r/FS9waAPEg178rUcL93oH";

int size = 500;
String bg = "http://img11.hc360.cn/11/busin/109/955/b/11-109955021.jpg";

BufferedImage img = QrCodeGenWrapper.of(msg)
        .setW(size)
        .setH(size)
        .setDetectImg("jihe/PDP.png")
        .setErrorCorrection(ErrorCorrectionLevel.H)
        .setDrawEnableScale(true)
        .setDrawStyle(QrCodeOptions.DrawStyle.IMAGE)
        .addImg(1, 1, "jihe/a.png")
        .addImg(3, 1, "jihe/b.png")
        .addImg(1, 3, "jihe/c.png")
        .addImg(3, 2, "jihe/e.png")
        .addImg(2, 3, "jihe/f.png")
        .addImg(2, 2, "jihe/g.png")
        .addImg(3, 4, "jihe/h.png")
        .setBgStyle(QrCodeOptions.BgImgStyle.PENETRATE)
        .setBgOpacity(1.0f)
        .setBgImg(bg)
        .setBgStartX(10)
        .setBgStartY(100)
        .asBufferedImage();

ImageIO.write(img, "png", new File("/tmp/q1.png"));
```


使用这种方式，需要稍微注意一下

- 必须制定DrawStyle为图片模式
- `addImg(row, column, img)` 来声明素材对应的应用场景，这个表示当出现一个row行，column列都有信息时，用img来填充

下面是一个输出实例

![几何二维码.png](http://ww1.sinaimg.cn/large/8154e929gy1g8qofh3ytnj20dw0dw3z5.jpg)


### g. 动态二维码

接下来介绍一下动态二维码的生成，其实和前面并没有什么区别，就是在设置背景时，指定为gif背景即可


```java
String msg = "http://weixin.qq.com/r/FS9waAPEg178rUcL93oH";
// 根据本地文件生成待logo的二维码， 重新着色位置探测图像
String logo = "logo.jpg";
String bg = "http://ww1.sinaimg.cn/large/8154e929gy1g8qe2iv0evg20xc0irn68.gif";
boolean ans = QrCodeGenWrapper.of(msg)
        .setW(400)
        .setDrawStyle(QrCodeOptions.DrawStyle.IMAGE)
        .setDetectImg("jihe/PDP.png")
        .addImg(1, 1, "jihe/a.png")
        .addImg(3, 1, "jihe/b.png")
        .addImg(1, 3, "jihe/c.png")
        .addImg(3, 2, "jihe/e.png")
        .addImg(2, 3, "jihe/f.png")
        .addImg(2, 2, "jihe/g.png")
        .addImg(3, 4, "jihe/h.png")
        .setPadding(1)
        .setErrorCorrection(ErrorCorrectionLevel.H)
        .setLogo(logo)
        .setLogoBorder(true)
        .setBgImg(bg)
        .setBgStyle(QrCodeOptions.BgImgStyle.FILL)
        .setBgStartX(20)
        .setBgStartY(137)
        .setBgOpacity(0.9f)
        .setPicType("gif")
        .asFile("/tmp/out2.gif");
System.out.println(ans);
```

下面是输出实例:

![out2.gif](http://ww1.sinaimg.cn/large/8154e929gy1g8qon6w9fdg20xc0ir1jw.gif)


